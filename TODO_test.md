# План улучшения тестов VideoGrabberBot

Этот документ содержит пошаговый план улучшения тестовой инфраструктуры проекта VideoGrabberBot для решения проблем с изоляцией тестов, зависимостью от деталей реализации и предсказуемостью выполнения тестов.

## Текущие проблемы

1. **Отсутствие изоляции между тестами**
   * Тесты влияют друг на друга при запуске всего набора
   * Тесты проходят при индивидуальном запуске, но падают при полном прогоне

2. **Зависимость от деталей реализации**
   * Тесты напрямую взаимодействуют с внутренними структурами (URL_STORAGE)
   * Используют моки и патчи для внутренних переменных вместо проверки поведения

3. **Проблемы с кэшированием и состоянием**
   * Декораторы @lru_cache вызывают непредсказуемое поведение в тестах
   * Глобальные переменные не сбрасываются между тестами

4. **Непредсказуемость тестов**
   * Разные результаты при запуске одиночных тестов и всего набора
   * Тесты чувствительны к порядку выполнения

## План улучшения

### Этап 1: Подготовка базовой инфраструктуры

- [x] 1.1. Создать корневой conftest.py для базовых фикстур
   - [x] Фикстура для сброса URL_STORAGE между тестами
   - [x] Фикстура для event_loop (для асинхронных тестов)
   - [x] Базовые фикстуры для мокирования конфигурации

- [x] 1.2. Настроить конфигурацию pytest для лучшей изоляции
   - [x] Проверить и улучшить настройки в pyproject.toml
   - [x] Добавить необходимые опции для вывода дополнительной информации при ошибках

### Этап 2: Улучшение тестов модуля formats

- [x] 2.1. Рефакторинг test_formats.py
   - [x] Переработать тесты для использования фикстур для изоляции от конфигурации
   - [x] Добавить тесты для крайних случаев и ошибок
   - [x] Обеспечить учет потенциального кэширования в будущем

### Этап 3: Улучшение тестов модуля storage

- [x] 3.1. Рефакторинг test_storage.py
   - [x] Переработать тесты для использования фикстур для сброса состояния
   - [x] Улучшить тестирование всего жизненного цикла URL в хранилище
   - [x] Добавить тесты для множественных URL и крайних случаев

### Этап 4: Улучшение тестов модуля url_processing

- [x] 4.1. Рефакторинг test_url_processing.py
   - [x] Разделить сложные тесты на более простые и изолированные
   - [x] Использовать подготовленные фикстуры для изоляции
   - [x] Избегать прямого доступа к внутренним структурам

### Этап 5: Проверка интеграции и документация

- [ ] 5.1. Прогон всех тестов вместе для проверки изоляции
   - [ ] Запустить все тесты в произвольном порядке
   - [ ] Проверить стабильность и предсказуемость результатов

- [ ] 5.2. Документация изменений
   - [ ] Обновить документацию по тестированию
   - [ ] Добавить комментарии к ключевым фикстурам и тестам

## Критерии успеха

1. Все тесты проходят независимо от порядка запуска
2. Тесты не зависят от деталей реализации, только от публичного API
3. Каждый тест полностью изолирован от других
4. Тесты предсказуемы и стабильны при многократных запусках
5. Улучшено покрытие тестами, включая крайние случаи
