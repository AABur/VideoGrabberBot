План разработки (этапы)

1. Подготовительный этап и регистрация бота
	•	Регистрация бота в Telegram:
	•	Создать бота через BotFather, получить TELEGRAM_TOKEN и сохранить его в файле .env.
	•	Инициализация репозитория и структуры проекта:
	•	Создать Git-репозиторий с необходимой структурой каталогов (см. архитектуру проекта).
	•	Настроить файл .gitignore для исключения виртуального окружения, файла .env и временных файлов.
	•	Настройка менеджера зависимостей:
	•	Инициализировать проект через uv и создать pyproject.toml с зависимостями (aiogram, yt-dlp, mypy, pytest, ruff, loguru и т.д.).

⸻

2. Настройка конфигурации, базы данных и логирования
	•	Конфигурация (config.py):
	•	Реализовать загрузку переменных из .env (например, TELEGRAM_TOKEN).
	•	Настроить пути для временных файлов и подключение к базе SQLite для хранения пользователей.
	•	База данных (модуль db.py):
	•	Создать таблицы для авторизованных пользователей и приглашений.
	•	Реализовать функции добавления/удаления и проверки доступа.
	•	Логирование (модуль logging.py с Loguru):
	•	Настроить Loguru с уровнями логирования (DEBUG, INFO, WARNING, ERROR).
	•	Интегрировать логирование сразу во все основные модули.
	•	Реализовать функцию для отправки уведомлений об ошибках администратору через Telegram.

Примечание: Параллельно с написанием каждого модуля создаются модульные тесты (pytest) для проверки корректности работы.

⸻

3. Инициализация Telegram-бота и базовые обработчики
	•	Инициализация aiogram:
	•	Создать объект Bot и Dispatcher в модуле telegram_api/client.py.
	•	Подключить базовые обработчики команд.
	•	Базовые команды (handlers/commands.py):
	•	/start, /help – вывод справочной информации.
	•	/invite – генерация уникальной ссылки-приглашения.
	•	/adduser – команда для администратора по добавлению пользователей по их Telegram User Name.
	•	Проверка авторизации:
	•	В каждом обработчике реализовать проверку доступа через базу SQLite.
	•	Интеграционные тесты:
	•	Создать тесты для проверки корректности работы базовых команд и авторизации.
	•	Проверка функциональности:
	•	Возможность запустить бота в тестовом режиме для проверки работы команд в реальном чате.

⸻

4. Реализация функционала скачивания (базовая версия)
	•	Функция скачивания:
	•	В services/downloader.py реализовать базовую функцию скачивания контента с YouTube (с использованием yt-dlp) без выбора формата.
	•	Обработать передачу файла через Telegram (в виде документа, учитывая поддержку файлов до 2 ГБ).
	•	Параллельное тестирование:
	•	Написать модульные тесты для функции скачивания (с использованием моков для yt-dlp).
	•	Логировать начало, завершение и возможные ошибки скачивания.

⸻

5. Реализация выбора формата скачивания
	•	Формирование списка форматов (services/formats.py):
	•	Реализовать логику формирования списка доступных форматов:
	•	Видео: SD (480p), HD (720p), Full HD (1080p), Original.
	•	Аудио: MP3 (320 kbps).
	•	Обработчик выбора формата (handlers/download.py):
	•	После получения ссылки – запросить список форматов и отправить InlineKeyboard с вариантами.
	•	Обработать callback-запрос, связанный с выбором формата, и поставить задачу скачивания в очередь.
	•	Тестирование:
	•	Создать тесты для проверки корректности формирования списка форматов и работы InlineKeyboard.
	•	Логировать выбор пользователя и постановку задачи в очередь.

⸻

6. Реализация очереди задач для скачивания
	•	Очередь задач:
	•	Внедрить механизм очереди для последовательного выполнения запросов.
	•	При поступлении нового запроса, если бот занят – уведомлять пользователя о постановке в очередь.
	•	Логирование очереди:
	•	Логировать добавление задачи в очередь, начало обработки и завершение.
	•	Тесты:
	•	Написать тесты, имитирующие последовательное выполнение запросов, чтобы убедиться, что очередь работает корректно.

⸻

7. Оптимизация работы с YouTube
	•	Оптимизация логики скачивания:
	•	В handlers/download.py оптимизировать обработку YouTube-ссылок.
	•	В services/downloader.py улучшить поддержку скачивания контента с YouTube через yt-dlp.
	•	Параллельное тестирование:
	•	Написать дополнительные тесты для функционала YouTube.
	•	Логировать все действия скачивания.

⸻

8. Обработка ошибок и уведомление администратора
	•	Обработка исключений:
	•	Во всех критических блоках (скачивание, выбор формата, работа с базой) добавить try/except с логированием ошибок.
	•	Использовать Loguru для записи ошибок с детализацией (включая стек вызовов).
	•	Уведомление администратора:
	•	При возникновении критических ошибок отправлять сообщение-уведомление администратору через aiogram.
	•	Тестирование ошибок:
	•	Создать тесты, имитирующие ошибки (например, недопустимый URL, сбой yt-dlp) и проверять, что администратор получает уведомление.

⸻

9. Интеграционное тестирование и проверка новой функциональности
	•	Интеграционные тесты:
	•	Создать окружение для интеграционного тестирования, позволяющее запускать бота и проверять последовательную работу всех модулей.
	•	Тестировать полные сценарии – от получения команды до отправки файла, включая обработку очереди.
	•	Проверка в реальном времени:
	•	Обеспечить возможность быстрого запуска тестовой версии бота для ручной проверки новой функциональности в Telegram.
	•	Использовать CI/CD (если требуется) для автоматизированного запуска тестов при каждом изменении в коде.

⸻

10. Документация и деплой
	•	Документация:
	•	Обновить README.md с подробными инструкциями по установке, настройке и запуску проекта.
	•	Описать порядок деплоя напрямую из GitHub-репозитория (например, через автоматизированный pull и запуск скрипта).
	•	Финальное интеграционное тестирование:
	•	Провести комплексное тестирование всех функций в тестовой среде.
	•	Подготовить проект к деплою и обеспечить возможность быстрого обновления кода через GitHub.

⸻