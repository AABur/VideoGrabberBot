# Задание - решение

## Руководство по развертыванию Docker-приложения на Synology NAS DS423+

Это руководство поможет вам развернуть ваше существующее Docker-приложение на Synology NAS DS423+. Мы пройдем все этапы, от первоначальной настройки NAS до запуска и управления вашим контейнером.

### 1. Предварительные требования
* Убедитесь, что ваш Synology NAS DS423+ настроен, подключен к сети и доступен через веб-интерфейс.
* Обновите DiskStation Manager (DSM) до последней версии:
    * Войдите в DSM как администратор.
    * Откройте **Панель управления > Обновление и восстановление > Обновление DSM** и проверьте наличие обновлений.
* Убедитесь, что ваше Docker-приложение успешно контейнеризовано, и у вас есть Docker-образ (например, на Docker Hub или в виде `Dockerfile`).
* Компьютер в той же сети, что и NAS, для начальной настройки.
* Базовое понимание того, что такое образы и контейнеры Docker.

### 2. Подготовка Synology NAS
* **Вход в DSM**: Откройте браузер и введите IP-адрес вашего NAS (например, `http://<IP-адрес_вашего_NAS>:5000`). Войдите, используя учетные данные администратора.
* **Создание общей папки для Docker**: Рекомендуется создать отдельную общую папку для хранения постоянных данных Docker и файлов конфигурации.
    * Откройте **Панель управления > Общая папка > Создать > Создать общую папку**.
    * Назовите папку (например, `docker`).
    * Выберите местоположение (например, `Volume 1`).
    * Настройте разрешения по умолчанию. Дополнительные разрешения для конкретных контейнеров можно настроить позже.
    * Завершите создание папки.
* **Настройка брандмауэра Synology (при необходимости)**: Если у вас включен брандмауэр Synology, убедитесь, что он не будет блокировать необходимые порты для Docker и ваших приложений.
    * Откройте **Панель управления > Безопасность > Брандмауэр**.
    * Вы можете добавить правила, разрешающие трафик на порты, которые будут использовать ваши Docker-контейнеры.
* **(Опционально, но рекомендуется) Включение службы SSH**: Это может быть полезно для расширенного управления и устранения неполадок.
    * Откройте **Панель управления > Терминал и SNMP > Терминал**.
    * Установите флажок **Включить службу SSH** (порт по умолчанию `22`).
    * Нажмите **Применить**.

### 3. Установка и настройка Docker (Container Manager)
* **Установка Container Manager (ранее Docker)**: На Synology NAS пакет Docker теперь называется `Container Manager`.
    * Откройте **Центр пакетов**.
    * В строке поиска введите `Container Manager`.
    * Нажмите **Установить** под пакетом `Container Manager`. Дождитесь завершения установки.
* **Обзор Container Manager**:
    * Запустите `Container Manager` из главного меню DSM.
    * Вы увидите разделы: **Обзор**, **Контейнер**, **Образ**, **Сеть**, **Журнал** и **Проект** (для Docker Compose).
* **Настройка Docker Compose (через раздел "Проект")**: Docker Compose позволяет определять и запускать многоконтейнерные Docker-приложения с помощью YAML-файла. `Container Manager` в DSM имеет встроенную поддержку для этого через функцию "Проект".
    * Вам понадобится файл `docker-compose.yml` для вашего приложения.
    * Вы можете создать этот файл на своем компьютере и загрузить его на NAS (например, в созданную ранее папку `docker`) или создать его непосредственно на NAS через SSH.

### 4. Развертывание приложения

Существует два основных способа развертывания вашего приложения: напрямую из образа (для простых приложений) или с использованием Docker Compose (рекомендуется для многоконтейнерных приложений или для более удобного управления конфигурацией).

**Способ 1: Развертывание одного контейнера через интерфейс Container Manager**

* **Загрузка Docker-образа**:
    * В `Container Manager` перейдите в раздел **Образ**.
    * Нажмите **Добавить > Добавить из URL-адреса или репозитория**.
    * Если ваш образ находится на Docker Hub, просто введите имя образа и тег (например, `nginx:latest`). Если это приватный репозиторий, вам могут потребоваться учетные данные.
    * Нажмите **Добавить**. Образ будет загружен на ваш NAS.
* **Создание и запуск Docker-контейнера**:
    * После загрузки образа выберите его в списке и нажмите **Запустить**.
    * **Общие настройки**:
        * **Имя контейнера**: Задайте имя вашему контейнеру (например, `my-web-app`).
        * **Включить автоматический перезапуск**: Рекомендуется для большинства приложений.
    * **Настройки порта**:
        * Нажмите **Настройки порта**.
        * Укажите **Локальный порт** на NAS, который будет сопоставлен с **Портом контейнера** (например, Локальный порт `8080` -> Порт контейнера `80`).
    * **Настройки тома** (см. раздел 5 для деталей):
        * Нажмите **Настройки тома > Добавить папку**.
        * Выберите путь на NAS (например, `/volume1/docker/myapp_config`) и укажите **Путь подключения** внутри контейнера.
    * **Переменные среды**:
        * В разделе **Переменные среды** нажмите **Добавить** и введите `Имя переменной` и `Значение`.
    * Просмотрите настройки и нажмите **Готово**. Контейнер будет создан и запущен.

**Способ 2: Развертывание с использованием Docker Compose (через "Проект")**

* **Подготовка файла `docker-compose.yml`**: Убедитесь, что ваш файл `docker-compose.yml` готов. Пример для веб-приложения с базой данных MySQL (как в вашем запросе):
    ```yaml
    version: '3.8' # Используйте актуальную версию
    services:
      web:
        image: my-web-app:latest # Замените на ваш образ
        ports:
          - "8080:80" # Локальный порт 8080 : Порт контейнера 80
        environment:
          - DB_HOST=db
          - DB_USER=myuser
          - DB_PASSWORD=mypassword
          - DB_NAME=mydb
        depends_on:
          - db
        restart: always

      db:
        image: mysql:latest # Или конкретная версия, например mysql:8.0
        environment:
          - MYSQL_ROOT_PASSWORD=mypassword
          - MYSQL_DATABASE=mydb
          - MYSQL_USER=myuser
          - MYSQL_PASSWORD=mypassword
        volumes:
          - /volume1/docker/mysql_data:/var/lib/mysql # Пример пути на NAS
        restart: always

    # volumes:
    #   db-data: # Это имя тома Docker, если вы хотите, чтобы Docker управлял им.
               # В примере выше для db мы используем bind mount для большей прозрачности на NAS.
               # Если вы хотите использовать Docker managed volume, то в сервисе db будет:
               # volumes:
               #  - db-data:/var/lib/mysql
               # И этот внешний 'volumes: db-data:' блок будет создавать его.
               # Для Synology часто удобнее использовать прямые пути, как /volume1/docker/mysql_data.
    ```
    **Примечание**: В примере выше для сервиса `db` том `/volume1/docker/mysql_data` является *bind mount*. Это означает, что данные будут храниться непосредственно в указанной папке на вашем NAS. Убедитесь, что папка `/volume1/docker/mysql_data` существует или будет создана с правильными разрешениями.

* **Развертывание проекта**:
    * В `Container Manager` перейдите в раздел **Проект**.
    * Нажмите **Создать**.
    * **Имя проекта**: Задайте имя вашему проекту (например, `my-application`).
    * **Источник**: Выберите **Загрузить Docker-Compose.yml**.
    * **Путь**: Укажите путь к папке на NAS, где будет храниться ваш `docker-compose.yml` (например, создайте подпапку в `/volume1/docker/my-project/`). Либо, если вы хотите, чтобы DSM управлял этим, выберите подходящее место.
    * **Загрузить**: Нажмите кнопку "Загрузить" и выберите ваш локальный файл `docker-compose.yml`.
    * Нажмите **Далее**. Проверьте конфигурацию.
    * Нажмите **Готово**. DSM проанализирует файл `docker-compose.yml`, загрузит необходимые образы (если их еще нет) и запустит ваши контейнеры.

### 5. Управление постоянными данными
* Постоянные данные важны для приложений, которые должны сохранять информацию между перезапусками контейнера (например, базы данных, файлы конфигурации, загруженные пользователем файлы).
* **Использование томов (Volumes)**:
    * **Bind Mounts (Монтирование привязкой)**: Вы монтируете папку с вашего NAS непосредственно в файловую систему контейнера. Это наиболее распространенный и рекомендуемый способ на Synology, так как он дает вам прямой доступ к данным из `File Station`.
        * **Создание папки на NAS**: Перед запуском контейнера создайте папку на вашем NAS, где будут храниться данные (например, `/volume1/docker/myapp_data`).
        * **Монтирование через интерфейс Container Manager**:
            * При создании или редактировании контейнера перейдите в **Настройки тома**.
            * Нажмите **Добавить папку**.
            * **Путь к файлу/папке**: Выберите созданную папку на NAS.
            * **Путь монтирования**: Укажите путь внутри контейнера, куда эта папка должна быть смонтирована (например, `/app/data` или `/var/lib/mysql` для MySQL).
        * **Монтирование через `docker-compose.yml`**:
            ```yaml
            services:
              myapp:
                # ...
                volumes:
                  - /volume1/docker/myapp_data:/app/data # Путь на NAS : Путь в контейнере
            ```
    * **Разрешения**: Убедитесь, что у пользователя, от имени которого запускается процесс внутри контейнера, есть права на чтение и запись в смонтированную папку на NAS. Иногда может потребоваться настроить разрешения для папки через `File Station` (правый клик на папку > Свойства > Разрешения), предоставив доступ системным пользователям Docker или группе `users`.

### 6. Настройка сети и портов
* **Сопоставление портов (Port Mapping)**: Чтобы получить доступ к вашему приложению, работающему в контейнере, из вашей локальной сети, вам нужно сопоставить порт на вашем NAS (локальный порт) с портом, который слушает приложение внутри контейнера (порт контейнера).
    * **Через интерфейс Container Manager**: Как описано в разделе 4 (Способ 1), в "Настройках порта".
    * **Через `docker-compose.yml`**:
        ```yaml
        services:
          myapp:
            # ...
            ports:
              - "8080:80" # Локальный порт NAS 8080 -> Порт контейнера 80
        ```
        После этого приложение будет доступно по адресу `http://<IP-адрес_вашего_NAS>:8080`.
* **Брандмауэр Synology**: Если брандмауэр Synology включен, убедитесь, что вы разрешили входящие подключения на локальный порт, который вы сопоставили (например, `8080`).
    * **Панель управления > Безопасность > Брандмауэр**. Создайте правило, разрешающее трафик TCP на нужный порт.
* **Переадресация портов на маршрутизаторе (для доступа извне)**: Если вы хотите, чтобы ваше приложение было доступно из Интернета, вам нужно будет настроить переадресацию портов на вашем маршрутизаторе, чтобы он направлял внешний трафик на IP-адрес вашего NAS и сопоставленный локальный порт. **Будьте осторожны с безопасностью при открытии портов во внешний мир.** Рассмотрите использование обратного прокси и SSL-сертификатов.

### 7. Запуск и управление контейнером
* **Через интерфейс Container Manager**:
    * **Раздел "Контейнер"**: Здесь вы видите список всех ваших контейнеров, их статус (работает, остановлен), использование ЦП/памяти.
        * **Запуск/Остановка/Перезапуск**: Выберите контейнер и используйте кнопки "Действие" > "Запустить", "Остановить" или "Перезапустить".
        * **Сведения**: Нажмите на имя контейнера, чтобы просмотреть подробную информацию, включая конфигурацию портов, томов, переменных среды и журналы.
        * **Журналы**: Вкладка "Журнал" в сведениях о контейнере показывает стандартный вывод вашего приложения, что очень полезно для отладки.
    * **Раздел "Проект"**: Если вы использовали `docker-compose.yml`.
        * Выберите ваш проект.
        * **Действия**: Здесь вы можете "Запустить" (эквивалент `docker compose up -d`), "Остановить" (`docker compose down`), "Удалить" (удаляет контейнеры и сети проекта), или "Изменить" (позволяет обновить `docker-compose.yml` и пересоздать проект).
* **(Опционально) Через SSH**: Если вы включили SSH, вы можете управлять контейнерами с помощью стандартных команд Docker CLI. Подключайтесь к NAS через SSH (например, `ssh ваш_пользователь@<IP-адрес_вашего_NAS>`).
    * Просмотр запущенных контейнеров:
        ```bash
        sudo docker ps
        ```
    * Просмотр всех контейнеров (включая остановленные):
        ```bash
        sudo docker ps -a
        ```
    * Запуск контейнера:
        ```bash
        sudo docker start <имя_контейнера_или_id>
        ```
    * Остановка контейнера:
        ```bash
        sudo docker stop <имя_контейнера_или_id>
        ```
    * Перезапуск контейнера:
        ```bash
        sudo docker restart <имя_контейнера_или_id>
        ```
    * Просмотр логов контейнера:
        ```bash
        sudo docker logs <имя_контейнера_или_id>
        ```
    * Для проектов Docker Compose (перейдите в папку с `docker-compose.yml`):
        * Запуск проекта в фоновом режиме:
            ```bash
            sudo docker compose up -d
            ```
        * Остановка и удаление контейнеров проекта:
            ```bash
            sudo docker compose down
            ```
        * Просмотр логов всех сервисов проекта:
            ```bash
            sudo docker compose logs -f
            ```

### 8. Устранение неполадок
* **Контейнер не запускается или сразу останавливается**:
    * **Проверьте журналы контейнера**: В `Container Manager` выберите контейнер > Сведения > Журнал. Ищите сообщения об ошибках.
    * **Конфликт портов**: Убедитесь, что локальный порт, который вы пытаетесь использовать, не занят другим сервисом на NAS или другим контейнером. Попробуйте изменить локальный порт.
    * **Неправильные пути монтирования томов**: Убедитесь, что пути к папкам на NAS указаны правильно и что папки существуют.
    * **Ошибки в переменных среды**: Дважды проверьте имена и значения переменных среды.
    * **Недостаточно ресурсов**: Проверьте **Мониторинг ресурсов** на NAS. Возможно, не хватает ОЗУ или ЦП.
    * **Неправильный образ или тег**: Убедитесь, что имя образа и тег указаны верно, и образ совместим с архитектурой вашего NAS (DS423+ использует архитектуру x86-64, большинство стандартных образов Docker Hub должны работать).
* **Приложение недоступно по сети**:
    * Убедитесь, что контейнер запущен.
    * Проверьте правильность сопоставления портов.
    * Проверьте настройки брандмауэра Synology (должен быть разрешен локальный порт).
    * Проверьте, доступен ли NAS по IP-адресу.
    * Попробуйте очистить кэш браузера или использовать другой браузер/режим инкогнито.
* **Проблемы с разрешениями для томов (данных)**:
    * Процесс внутри контейнера может работать от имени определенного пользователя (UID/GID). Этот пользователь должен иметь права на чтение/запись в смонтированную папку на NAS.
    * Попробуйте установить более широкие разрешения на папку на NAS для тестирования (например, для группы `users` или `everyone`), а затем сузить их.
    * Иногда помогает установить владельцем папки на NAS пользователя `admin` или того пользователя, под которым работает Docker. В некоторых случаях может потребоваться явно задать UID/GID для контейнера через переменные среды или конфигурацию `docker-compose.yml`, если образ это поддерживает.
* **Ошибка "Image not found" (Образ не найден) при загрузке**:
    * Проверьте правильность написания имени образа и тега.
    * Убедитесь, что NAS имеет доступ к Интернету для загрузки образов из Docker Hub или другого репозитория.
    * Если образ приватный, убедитесь, что вы правильно настроили аутентификацию.

---

Следуя этому руководству, вы сможете успешно развернуть и запустить ваше Docker-приложение на Synology NAS DS423+. Если возникнут специфические проблемы с вашим приложением, журналы контейнера обычно являются лучшим местом для начала диагностики. Удачи!