# TODO (критически важные задачи для частного NAS-сценария)

- Обработка инвайтов в /start (deep-link): добавить разбор параметра `start=<code>` и вызов `use_invite(...)` с валидацией.
  Обоснование: простой онбординг без ручного user_id; исключает необходимость админ-команд для каждого.

- Валидация и логирование на старте: вызывать `setup_logger()` и `config.validate_all()` при запуске (например, в `run.py`/`bot.main`).
  Обоснование: раннее выявление ошибок конфигурации и корректные ротационные логи на NAS.

- Обновляемость yt-dlp: добавить make-таргет/скрипт для обновления yt-dlp или пересборки контейнера; задокументировать.
  Обоснование: YouTube часто меняет механики; редкое использование = высокий риск внезапных поломок без апдейта.

- Повторы и таймауты загрузок: настроить для yt-dlp `retries`, `fragment_retries`, `socket_timeout` и простой backoff.
  Обоснование: домашний интернет/NAS может быть нестабилен; снизит ложные ошибки.

- Очистка `data/temp` на старте и периодическая: удалять «висячие» файлы и всё старше N дней.
  Обоснование: после сбоев остаются остатки, место на NAS ограничено.

- Строгая валидация URL: парсить URL (urlparse) и проверять домены `*.youtube.*`/`youtu.be` вместо подстроки.
  Обоснование: избежать ложноположительных URL и бесполезных попыток скачивания.

- Экранирование HTML-разметки в сообщениях: экранировать динамические `title`/`URL` перед отправкой (ParseMode.HTML).
  Обоснование: предотвращает поломку разметки и нежелательные теги в сообщениях.

- Ограничение типов чатов: явно запрещать группы/супергруппы, работать только в приватных чатах.
  Обоснование: приватность данных для узкого круга пользователей.

- Бэкап и обслуживание SQLite: простой cron/скрипт — копия `data/bot.db` и `VACUUM` (например, при старте раз в неделю).
  Обоснование: снижает риск коррапции на NAS и неконтролируемого роста файла.

- Экспирация инвайтов: добавить TTL (например, 24–72 ч) и авто-деактивацию просроченных приглашений.
  Обоснование: утечка старой ссылки не должна давать постоянный доступ.

- Тюнинг лимитов очереди по умолчанию через `.env`: `MAX_QUEUE_SIZE=10`, `MAX_USER_TASKS=2` для домашней среды.
  Обоснование: ограниченные ресурсы NAS и редкое использование — меньше риск «забивания» очереди.

- Команда `/status`: показывать состояние (длина очереди, активность воркера, версия yt-dlp).
  Обоснование: быстрая диагностика без просмотра логов.

