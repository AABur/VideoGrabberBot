Техническое задание: VideoGrabberBot

Краткое описание проекта

VideoGrabberBot – это Telegram-бот, предназначенный для скачивания видео и аудио из YouTube по предоставленной ссылке. Бот предоставляет пользователю возможность выбора формата скачивания: для видео – варианты SD (480p), HD (720p), Full HD (1080p) и Original (максимальное доступное качество, включая 2K/4K), для аудио – MP3 (320 kbps). Полученный файл отправляется непосредственно в чат. Доступ к боту осуществляется либо по уникальной ссылке-приглашению, либо пользователи добавляются администратором (по их Telegram User Name). Информация о пользователях хранится в базе SQLite. В случае возникновения ошибок, бот уведомляет администратора. Развертывание производится непосредственно из GitHub-репозитория без использования Docker.

Функциональные требования
	•	Поддержка источников:
	•	YouTube: Использовать библиотеку yt-dlp для извлечения и скачивания контента. Возможность дальнейшего расширения для поддержки других платформ через yt-dlp.
	•	Выбор формата перед скачиванием:
	•	Видео форматы:
	•	SD (480p): для слабого интернет-соединения, экономия трафика.
	•	HD (720p): хороший баланс качества и размера файла.
	•	Full HD (1080p): высокое качество для современных устройств.
	•	Original: максимальное доступное качество (включая 2K/4K).
	•	Аудио формат:
	•	MP3 (320 kbps): высокое качество звука, универсальный формат.
	•	После отправки ссылки бот извлекает доступные варианты и формирует сообщение с кнопками (InlineKeyboard) для выбора конкретного формата.
	•	Ограниченный доступ:
	•	Доступ к боту реализуется либо посредством уникальной ссылки-приглашения, либо через механизм добавления пользователей администратором по их Telegram User Name.
	•	Информация о пользователях, имеющих доступ, хранится в базе данных SQLite.
	•	При обращении неавторизованного пользователя бот должен уведомить его о невозможности использования сервиса.
	•	Логирование и обработка ошибок:
	•	Использовать Loguru для логирования. Loguru обеспечивает современное форматирование, поддержку асинхронности и низкие накладные расходы.
	•	Все ключевые события (запуск, получение запросов, начало и окончание скачивания) логируются.
	•	При возникновении ошибок – в дополнение к уведомлением пользователя – бот отправляет сообщение-уведомление администратору (например, с подробностями ошибки и стектрейсом).
	•	Очередь задач:
	•	Для ограниченного числа пользователей и редкого одновременного использования реализовать очередь задач, чтобы гарантировать последовательное выполнение запросов без конфликтов.
	•	При поступлении нового запроса, если бот занят, пользователю может отправляться уведомление о постановке запроса в очередь.
	•	Работа с большими файлами:
	•	Проект должен поддерживать обработку файлов до 2 ГБ.
	•	Для отправки таких файлов использовать способ передачи в виде документа через Telegram (поскольку формат медиа-сообщений имеет ограничения).
	•	При необходимости реализовать альтернативные подходы (например, отправка ссылки на файл после сохранения его на сервере), чтобы обеспечить возможность работы с крупными файлами.

Нефункциональные требования и инструменты разработки
	•	Управление зависимостями и окружением:
	•	Использовать uv для управления зависимостями и создания изолированного окружения. Конфигурация проекта оформляется в файле pyproject.toml с указанием всех зависимостей (например, aiogram, yt-dlp, mypy, pytest, ruff).
	•	Статическая типизация:
	•	Код снабжается аннотациями типов (по крайней мере, в сигнатурах функций) и проверяется с помощью mypy.
	•	Тестирование:
	•	Для модульного и интеграционного тестирования используется pytest.
	•	Тестируются основные модули: функции скачивания, выбор формата, проверка авторизации и обработка очереди запросов.
	•	Линтер и форматтер:
	•	Применяется Ruff для проверки стиля кода и автоматического форматирования.
	•	Контроль версий:
	•	Проект хранится в репозитории Git с продуманной историей коммитов. Файл .gitignore исключает виртуальное окружение, секретные файлы (например, .env) и другие временные файлы.
	•	Конфигурация:
	•	Секретные данные (например, TELEGRAM_TOKEN) хранятся в файле .env, который не добавляется в репозиторий.
	•	Дополнительные настройки (например, путь к базе данных SQLite для хранения пользователей) также настраиваются через переменные окружения.
	•	Логирование:
	•	Использовать Loguru для настройки логирования. Все логи, включая ошибки, форматируются современным образом. В случае ошибок, помимо локального логирования, бот уведомляет администратора.
	•	Выбор библиотеки для Telegram:
	•	Использовать aiogram как единственную библиотеку для взаимодействия с Telegram Bot API, что обеспечивает асинхронность и современное API.
	•	Деплой:
	•	Развертывание осуществляется напрямую из GitHub-репозитория. В проекте должны присутствовать инструкции для развёртывания без использования Docker.

Архитектура проекта

Общий подход

Проект оформляется как модульный пакет Python, с четким разделением функциональности между компонентами бота (обработка сообщений, бизнес-логика скачивания, утилиты, работа с базой данных и логированием). Ниже предложена структура каталогов с учетом внесенных изменений:

VideoGrabberBot/                # Корневая директория проекта
├── bot/                       # Основной пакет бота
│   ├── __init__.py
│   ├── main.py                # Точка входа: инициализация aiogram, запуск бота
│   ├── config.py              # Загрузка конфигурации из .env, настройка путей (например, база данных)
│   ├── handlers/              # Пакет с обработчиками команд и сообщений
│   │   ├── __init__.py
│   │   ├── commands.py        # Обработчики команд (/start, /help, /invite, /adduser)
│   │   └── download.py        # Обработка ссылок, выбор формата (InlineKeyboard) и обработка callback-запросов
│   ├── services/              # Бизнес-логика работы с внешними библиотеками
│   │   ├── __init__.py
│   │   ├── downloader.py      # Функции взаимодействия с yt-dlp: получение форматов, скачивание файлов
│   │   └── formats.py         # Логика формирования списка доступных форматов (SD, HD, Full HD, Original для видео и MP3 для аудио)
│   ├── utils/                 # Вспомогательные утилиты
│   │   ├── __init__.py
│   │   ├── logging.py         # Настройка логирования через Loguru
│   │   └── db.py              # Модуль для работы с базой SQLite (хранение авторизованных пользователей, приглашений)
│   └── telegram_api/          # Абстракция над aiogram (инициализация бота, диспетчера)
│       ├── __init__.py
│       └── client.py          # Инициализация объекта Bot и Dispatcher
├── tests/                     # Тесты (pytest)
│   ├── __init__.py
│   ├── test_downloader.py     # Тесты функций скачивания и формирования списка форматов
│   └── test_handlers.py       # Тесты обработчиков (проверка авторизации, очереди задач)
├── pyproject.toml             # Файл конфигурации проекта (uv, Ruff, mypy, pytest)
├── .env                     # Файл с переменными окружения (TELEGRAM_TOKEN, настройки базы и др.)
├── README.md                # Документация по проекту, инструкции по установке и деплою из GitHub
└── .gitignore               # Игнорирование виртуального окружения, .env и других временных файлов

Основные компоненты и их задачи
	•	main.py:
	•	Инициализация aiogram: создание объекта Bot (с токеном, загружаемым из .env) и Dispatcher.
	•	Подключение обработчиков команд и callback-запросов.
	•	Инициализация очереди задач для скачивания.
	•	Запуск бота (long polling или webhook, в зависимости от деплоя).
	•	Конфигурация (config.py):
	•	Загрузка секретных переменных (например, TELEGRAM_TOKEN) из файла .env.
	•	Чтение настроек для подключения к базе SQLite (например, путь к файлу базы).
	•	Прочие глобальные настройки (например, директория для временных файлов).
	•	Обработчики (handlers/):
	•	commands.py:
	•	Реализация базовых команд:
	•	/start – приветственное сообщение, разъяснение работы бота.
	•	/help – справка по использованию.
	•	/invite – генерация уникальной ссылки-приглашения для доступа.
	•	/adduser – команда для администратора по добавлению пользователей через Telegram User Name.
	•	download.py:
	•	Обработка сообщений, содержащих ссылки на видео/аудио.
	•	Выделение платформы по URL (YouTube или Instagram).
	•	Получение списка доступных форматов через вызов сервиса.
	•	Отправка пользователю сообщения с кнопками выбора (InlineKeyboard) для каждого варианта:
	•	Для видео: SD (480p), HD (720p), Full HD (1080p), Original.
	•	Для аудио: MP3 (320 kbps).
	•	Обработка callback-запроса: после выбора пользователем конкретного формата – постановка задачи в очередь скачивания.
	•	Сервисы (services/):
	•	downloader.py:
	•	Работа с библиотекой yt-dlp:
	•	Функция получения информации о доступных форматах (с фильтрацией вариантов согласно спецификации).
	•	Функция скачивания файла с заданным форматом, с указанием опций (например, параметр format).
	•	Обработка ошибок при скачивании: перехват исключений, логирование ошибки и уведомление администратора.
	•	formats.py:
	•	Логика формирования удобного списка для пользователя с вариантами форматов, включая человеческие описания для каждой опции.
	•	Утилиты (utils/):
	•	logging.py:
	•	Настройка Loguru для логирования: определение формата, уровня логов, вывода в файл и консоль.
	•	Функция для отправки уведомлений об ошибках администратору (через отдельное сообщение в Telegram).
	•	db.py:
	•	Функции для работы с SQLite: создание базы данных, таблиц для хранения пользователей и приглашений, добавление/удаление пользователей, запросы к базе.
	•	Обеспечение доступа к данным об авторизованных пользователях, что позволяет проверить, имеет ли пользователь право на использование бота.
	•	Telegram API взаимодействие (telegram_api/client.py):
	•	Абстрагирование и инициализация объектов aiogram (Bot и Dispatcher).
	•	Возможное инкапсулирование логики работы с обновлениями и отправкой сообщений.